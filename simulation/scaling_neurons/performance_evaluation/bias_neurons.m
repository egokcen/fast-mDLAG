% bias_neurons.m
%
% Description: Characterize the bias of mDLAG GP parameter estimates as a 
%              function of neuron number. Compare time, inducing point,
%              and frequency domain fitting approaches.
%
% Author: 
%     Evren Gokcen    egokcen@cmu.edu

%% Set up script parameters

set_consts_mdlag_scaling_neurons;

%% Characterize model performance

PLOT_INDUCING = false;  % Toggle mDLAG-inducing results

% Time domain
D_time = nan(numPartitions, numRuns);    % Time delays
tau_time = nan(numPartitions, numRuns);  % Timescales

if PLOT_INDUCING
    % Inducing points
    D_sparse = nan(numPartitions, numRuns);    % Time delays
    tau_sparse = nan(numPartitions, numRuns);  % Timescales
end

% Frequency domain
D_freq = nan(numPartitions, numRuns);    % Time delays
tau_freq = nan(numPartitions, numRuns);  % Timescales

% Frequency domain with taper
D_err_taper = nan(numPartitions, numRuns);    % Time delays
tau_err_taper = nan(numPartitions, numRuns);  % Timescales

for runIdx = 1:numRuns
    
    for i = 1:numPartitions
        yDims = yDimList(i,:);
        
        % Load fitted models
        results_time = load( ...
            sprintf('%s/run%03d/yDim%03d_time.mat', resultDir, runIdx, sum(yDims)) ...
        );
        if PLOT_INDUCING
            results_sparse = load( ...
                sprintf('%s/run%03d/yDim%03d_sparse.mat', resultDir, runIdx, sum(yDims)) ...
            );
        end
        results_freq = load( ...
            sprintf('%s/run%03d/yDim%03d_freq.mat', resultDir, runIdx, sum(yDims)) ...
        );
        results_taper = load( ...
            sprintf('%s/run%03d/yDim%03d_freq_taper.mat', resultDir, runIdx, sum(yDims)) ...
        );
        % Estimated parameters
        % Time domain
        gp_params_est_time = getGPparams_mdlag(results_time.estParams, binWidth);
        D_time(i,runIdx) = gp_params_est_time.D(end,1);
        tau_time(i,runIdx) = gp_params_est_time.tau(1);

        if PLOT_INDUCING
            % Inducing points
            gp_params_est_sparse = getGPparams_mdlag(results_sparse.estParams, binWidth);
            D_sparse(i,runIdx) = gp_params_est_sparse.D(end,1);
            tau_sparse(i,runIdx) = gp_params_est_sparse.tau(1);
        end

        % Frequency domain
        gp_params_est_freq = getGPparams_mdlag(results_freq.estParams, binWidth);
        D_freq(i,runIdx) = gp_params_est_freq.D(end,1);
        tau_freq(i,runIdx) = gp_params_est_freq.tau(1);

        % Frequency domain with taper
        gp_params_est_taper = getGPparams_mdlag(results_taper.estParams, binWidth);
        D_taper(i,runIdx) = gp_params_est_taper.D(end,1);
        tau_taper(i,runIdx) = gp_params_est_taper.tau(1);
        
    end

end

%% Visualize results

yDim = sum(yDimList,2)';

% Mean and SEM over runs
% Time domain
mean_D_time = mean(D_time,2);
sem_D_time = std(D_time,0,2) / sqrt(numRuns);
mean_tau_time = mean(tau_time,2);
sem_tau_time = std(tau_time,0,2) / sqrt(numRuns);

if PLOT_INDUCING
    % Inducing points
    mean_D_sparse = mean(D_sparse,2);
    sem_D_sparse = std(D_sparse,0,2) / sqrt(numRuns);
    mean_tau_sparse = mean(tau_sparse,2);
    sem_tau_sparse = std(tau_sparse,0,2) / sqrt(numRuns);
end

% Frequency domain
mean_D_freq = mean(D_freq,2);
sem_D_freq = std(D_freq,0,2) / sqrt(numRuns);
mean_tau_freq = mean(tau_freq,2);
sem_tau_freq = std(tau_freq,0,2) / sqrt(numRuns);

% Frequency domain with taper
mean_D_taper = mean(D_taper,2);
sem_D_taper = std(D_taper,0,2) / sqrt(numRuns);
mean_tau_taper = mean(tau_taper,2);
sem_tau_taper = std(tau_taper,0,2) / sqrt(numRuns);

figure;
% Timescales
h = [];
lbls = {};
subplot(1,2,1);
hold on;
% Ground truth
line([yDim(1) yDim(end)], [gp_params.tau(1) gp_params.tau(1)], ...
     'Color', 'k', ...
     'LineStyle', '--', ...
     'LineWidth', 1.5);
% Time domain
p = fill([yDim, fliplr(yDim)], ...
         [mean_tau_time + sem_tau_time; ...
          flipud(mean_tau_time - sem_tau_time)]', ...
         '', ...  % Add custom color below
         'edgecolor', 'none', ...
         'facealpha', 0.2);
p.FaceColor = TIMECOLOR;
h = [h, plot(yDim, mean_tau_time, ...
             'color', TIMECOLOR, ...
             'linestyle', '-', ...
             'linewidth', 1.5, ...
             'marker', '.', ...
             'markersize', 10)];
lbls = {lbls{:}, 'Time domain'};
if PLOT_INDUCING
    % Inducing points
    p = fill([yDim, fliplr(yDim)], ...
             [mean_tau_sparse + sem_tau_sparse; ...
              flipud(mean_tau_sparse - sem_tau_sparse)]', ...
             '', ...  % Add custom color below
             'edgecolor', 'none', ...
             'facealpha', 0.2);
    p.FaceColor = SPARSECOLOR;
    h = [h, plot(yDim, mean_tau_sparse, ...
                 'color', SPARSECOLOR, ...
                 'linestyle', '-', ...
                 'linewidth', 1.5, ...
                 'marker', '.', ...
                 'markersize', 10)];
    lbls = {lbls{:}, 'Inducing points'};
end
% Frequency domain
p = fill([yDim, fliplr(yDim)], ...
         [mean_tau_freq + sem_tau_freq; ...
          flipud(mean_tau_freq - sem_tau_freq)]', ...
         '', ...  % Add custom color below
         'edgecolor', 'none', ...
         'facealpha', 0.2);
p.FaceColor = FREQCOLOR;
h = [h, plot(yDim, mean_tau_freq, ...
             'color', FREQCOLOR, ...
             'linestyle', '-', ...
             'linewidth', 1.5, ...
             'marker', '.', ...
             'markersize', 10)];
lbls = {lbls{:}, 'Freq. domain'};
% Frequency domain with taper
p = fill([yDim, fliplr(yDim)], ...
         [mean_tau_taper + sem_tau_taper; ...
          flipud(mean_tau_taper - sem_tau_taper)]', ...
         '', ...  % Add custom color below
         'edgecolor', 'none', ...
         'facealpha', 0.2);
p.FaceColor = TAPERCOLOR;
h = [h, plot(yDim, mean_tau_taper, ...
             'color', TAPERCOLOR, ...
             'linestyle', '-', ...
             'linewidth', 1.5, ...
             'marker', '.', ...
             'markersize', 10)];
lbls = {lbls{:}, 'Taper'};
xlabel('No. units');
ylabel('Timescale (ms)');
ylim([0, gp_params.tau(1)*1.2])
xscale('log');
axis square;
legend(h, lbls, 'location', 'southoutside');
hold off;

% Time delays
h = [];
lbls = {};
subplot(1,2,2);
hold on;
% Ground truth
line([yDim(1) yDim(end)], [gp_params.D(end,1) gp_params.D(end,1)], ...
     'Color', 'k', ...
     'LineStyle', '--', ...
     'LineWidth', 1.5);
% Time domain
p = fill([yDim, fliplr(yDim)], ...
         [mean_D_time + sem_D_time; ...
          flipud(mean_D_time - sem_D_time)]', ...
         '', ...  % Add custom color below
         'edgecolor', 'none', ...
         'facealpha', 0.2);
p.FaceColor = TIMECOLOR;
h = [h, plot(yDim, mean_D_time, ...
             'color', TIMECOLOR, ...
             'linestyle', '-', ...
             'linewidth', 1.5, ...
             'marker', '.', ...
             'MarkerSize', 10)];
lbls = {lbls{:}, 'Time domain'};
if PLOT_INDUCING
    % Inducing points
    p = fill([yDim, fliplr(yDim)], ...
             [mean_D_sparse + sem_D_sparse; ...
              flipud(mean_D_sparse - sem_D_sparse)]', ...
             '', ...  % Add custom color below
             'edgecolor', 'none', ...
             'facealpha', 0.2);
    p.FaceColor = SPARSECOLOR;
    h = [h, plot(yDim, mean_D_sparse, ...
                 'color', SPARSECOLOR, ...
                 'linestyle', '-', ...
                 'linewidth', 1.5, ...
                 'marker', '.', ...
                 'markersize', 10)];
    lbls = {lbls{:}, 'Inducing points'};
end
% Frequency domain
p = fill([yDim, fliplr(yDim)], ...
         [mean_D_freq + sem_D_freq; ...
          flipud(mean_D_freq - sem_D_freq)]', ...
         '', ...  % Add custom color below
         'edgecolor', 'none', ...
         'facealpha', 0.2);
p.FaceColor = FREQCOLOR;
h = [h, plot(yDim, mean_D_freq, ...
             'color', FREQCOLOR, ...
             'linestyle', '-', ...
             'linewidth', 1.5, ...
             'marker', '.', ...
             'markersize', 10)];
lbls = {lbls{:}, 'Freq. domain'};
% Frequency domain with taper
p = fill([yDim, fliplr(yDim)], ...
         [mean_D_taper + sem_D_taper; ...
          flipud(mean_D_taper - sem_D_taper)]', ...
         '', ...  % Add custom color below
         'edgecolor', 'none', ...
         'facealpha', 0.2);
p.FaceColor = TAPERCOLOR;
h = [h, plot(yDim, mean_D_taper, ...
             'color', TAPERCOLOR, ...
             'linestyle', '-', ...
             'linewidth', 1.5, ...
             'marker', '.', ...
             'markersize', 10)];
lbls = {lbls{:}, 'Taper'};
xlabel('No. units');
ylabel('Time delay (ms)');
ylim([0, gp_params.D(end,1)*1.2])
xscale('log');
axis square;
legend(h, lbls, 'location', 'southoutside');
hold off;